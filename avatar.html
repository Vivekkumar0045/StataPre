<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Survey Avatar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            text-align: center;
            position: relative;
        }

        h1 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        h2 {
            color: #333;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .avatar-container {
            margin: 2rem auto;
            width: 300px;
            height: 300px;
            position: relative;
        }

        .avatar-image {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border: 5px solid #667eea;
        }

        .setup-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 2rem 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            text-align: left;
        }

        label {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        input[type="text"],
        input[type="password"],
        select {
            padding: 0.75rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-align: left;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0.5rem;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-explain {
            background: #ffc107;
            color: #333;
        }

        .btn-explain:hover {
            background: #e0a800;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        .question-text {
            font-size: 1.5rem;
            color: #333;
            margin: 1.5rem 0;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .countdown {
            font-size: 3rem;
            color: #667eea;
            font-weight: bold;
            margin: 2rem 0;
        }

        .recording-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: #dc3545;
            color: white;
            border-radius: 50px;
            font-weight: 600;
            margin: 1rem 0;
        }

        .recording-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .results-container {
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .result-item {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-question {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .result-answer {
            color: #666;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .dev-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffc107;
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .login-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .login-tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .login-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .login-tab:hover {
            background: #f8f9fa;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .welcome-text {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .admin-panel {
            text-align: left;
        }

        .question-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }

        .question-header {
            font-weight: 600;
            color: #667eea;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .script-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
        }

        .script-label {
            font-weight: 600;
            color: #555;
            min-width: 120px;
        }

        .script-text {
            flex: 1;
            color: #333;
        }

        .btn-play {
            padding: 0.5rem 1rem;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            min-width: 80px;
        }

        .btn-play:hover {
            background: #218838;
        }

        .btn-record {
            width: 100%;
            padding: 0.75rem;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .btn-record:hover {
            background: #c82333;
        }

        .btn-record.recorded {
            background: #28a745;
        }

        .btn-record.recorded:hover {
            background: #218838;
        }

        .admin-controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            justify-content: center;
        }

        .survey-title {
            color: #667eea;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="devBadge" class="dev-badge hidden">üîß DEV MODE</div>
        
        <!-- Login Page -->
        <div id="loginPage">
            <h1>üéôÔ∏è Voice Survey Portal</h1>
            <p class="welcome-text">Please sign in to continue</p>
            
            <div class="login-tabs">
                <button class="login-tab active" data-tab="user">User Login</button>
                <button class="login-tab" data-tab="admin">Admin Login</button>
            </div>

            <!-- User Login -->
            <div id="userLoginTab" class="tab-content active">
                <form id="userLoginForm" class="setup-form">
                    <div class="form-group">
                        <label for="userUsername">Username</label>
                        <input type="text" id="userUsername" required placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label for="userPassword">Password</label>
                        <input type="password" id="userPassword" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn btn-primary">Sign In as User</button>
                </form>
            </div>

            <!-- Admin Login -->
            <div id="adminLoginTab" class="tab-content">
                <form id="adminLoginForm" class="setup-form">
                    <div class="form-group">
                        <label for="adminUsername">Admin Username</label>
                        <input type="text" id="adminUsername" required placeholder="Enter admin username" value="admin">
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Admin Password</label>
                        <input type="password" id="adminPassword" required placeholder="Enter admin password">
                    </div>
                    <button type="submit" class="btn btn-primary">Sign In as Admin</button>
                </form>
            </div>
        </div>
        
        <!-- Setup Page -->
        <div id="setupPage" class="hidden">
            <h1>üéôÔ∏è Voice Survey Portal</h1>
            <h2>Step 1: Setup Your Survey Session</h2>
            
            <form id="setupForm" class="setup-form">
                <div class="form-group" id="userNameGroup">
                    <label for="userName">Your Name</label>
                    <input type="text" id="userName" required placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label for="language">Select Language</label>
                    <select id="language" required>
                        <option value="en">English</option>
                        <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="surveySelect">Select a Survey</label>
                    <select id="surveySelect" required>
                        <option value="">Loading surveys...</option>
                    </select>
                </div>
                
                <div class="checkbox-group" id="devModeGroup" style="display: none;">
                    <input type="checkbox" id="devMode">
                    <label for="devMode">üîß Developer Mode (Only 2 questions)</label>
                </div>
                
                <button type="submit" class="btn btn-primary">Start Survey</button>
            </form>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="hidden">
            <h1>üîß Admin Testing Panel</h1>
            <div id="surveyTitle" class="survey-title"></div>
            
            <div id="adminQuestions" class="admin-panel"></div>
            
            <div class="admin-controls">
                <button id="processAdminBtn" class="btn btn-primary">Process All Answers</button>
                <button id="backToSetupBtn" class="btn btn-secondary">Back to Setup</button>
            </div>
        </div>

        <!-- Survey Page -->
        <div id="surveyPage" class="hidden">
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            
            <h2 id="questionNumber">Question 1/10</h2>
            
            <div class="avatar-container">
                <img id="avatarImage" src="assets/avatar_static.png" alt="Avatar" class="avatar-image">
            </div>
            
            <div id="questionText" class="question-text">Loading question...</div>
            
            <div id="countdownDisplay" class="countdown hidden"></div>
            
            <div id="recordingIndicator" class="recording-indicator hidden">
                <div class="recording-dot"></div>
                Recording your answer...
            </div>
            
            <div id="devSkipMessage" class="alert alert-info hidden">
                üîß DEV MODE: Skipping question...
            </div>
            
            <div class="controls">
                <button id="pauseBtn" class="btn btn-secondary">‚è∏Ô∏è Pause Survey</button>
                <button id="explainBtn" class="btn btn-explain">üí° Explain Question</button>
            </div>
            
            <div id="explanationBox" class="alert alert-info hidden"></div>
            <div id="pausedWarning" class="alert alert-warning hidden">
                Survey is paused. Press Resume to continue.
            </div>
        </div>

        <!-- Processing Page -->
        <div id="processingPage" class="hidden">
            <h1>Survey Complete!</h1>
            <div class="alert alert-info">
                <div class="loading"></div>
                Thank you! Processing your answers...
            </div>
            <div id="processingProgress"></div>
            <div id="resultsContainer" class="results-container hidden"></div>
            <div id="processingControls" class="hidden">
                <button id="submitBtn" class="btn btn-primary">Submit Results to Server</button>
                <button id="newSurveyBtn" class="btn btn-secondary">Start New Survey</button>
            </div>
        </div>
    </div>

    <!-- Audio element for TTS playback -->
    <audio id="ttsAudio" style="display: none;"></audio>

    <script>
        // Configuration
        const CONFIG = {
            GOOGLE_API_KEY: 'AIzaSyD3yCsOLlaHLdY20f1gWxnoq-t4uc3tRYU',
            SUPABASE_URL: 'https://fmvpeaqtwgjsyktnjpfa.supabase.co',
            SUPABASE_KEY: 'sb_publishable_BdqDQJZ3UTt8thycysxDkQ_vdoYG6J8',
            SUPABASE_FORMS_BUCKET: 'survey-forms',
            API_BASE_URL: 'http://127.0.0.1:8000',
            RECORDING_DURATION: 5000, // milliseconds
            COUNTDOWN_DURATION: 5 // seconds
        };

        // State management
        let state = {
            currentPage: 'login',
            loggedInUser: null,
            isAdmin: false,
            userName: '',
            language: 'en',
            selectedSurvey: null,
            devMode: false,
            script: [],
            currentStep: 0,
            recordedAnswers: [],
            isPaused: false,
            surveyFlowState: 'asking', // asking, countdown, recording
            mediaRecorder: null,
            audioChunks: []
        };

        // DOM elements
        const elements = {
            loginPage: document.getElementById('loginPage'),
            userLoginForm: document.getElementById('userLoginForm'),
            adminLoginForm: document.getElementById('adminLoginForm'),
            userLoginTab: document.getElementById('userLoginTab'),
            adminLoginTab: document.getElementById('adminLoginTab'),
            setupPage: document.getElementById('setupPage'),
            adminPanel: document.getElementById('adminPanel'),
            surveyPage: document.getElementById('surveyPage'),
            processingPage: document.getElementById('processingPage'),
            setupForm: document.getElementById('setupForm'),
            userName: document.getElementById('userName'),
            language: document.getElementById('language'),
            surveySelect: document.getElementById('surveySelect'),
            devMode: document.getElementById('devMode'),
            devBadge: document.getElementById('devBadge'),
            questionNumber: document.getElementById('questionNumber'),
            avatarImage: document.getElementById('avatarImage'),
            questionText: document.getElementById('questionText'),
            countdownDisplay: document.getElementById('countdownDisplay'),
            recordingIndicator: document.getElementById('recordingIndicator'),
            devSkipMessage: document.getElementById('devSkipMessage'),
            pauseBtn: document.getElementById('pauseBtn'),
            explainBtn: document.getElementById('explainBtn'),
            explanationBox: document.getElementById('explanationBox'),
            pausedWarning: document.getElementById('pausedWarning'),
            progressFill: document.getElementById('progressFill'),
            ttsAudio: document.getElementById('ttsAudio'),
            processingProgress: document.getElementById('processingProgress'),
            resultsContainer: document.getElementById('resultsContainer'),
            processingControls: document.getElementById('processingControls'),
            submitBtn: document.getElementById('submitBtn'),
            newSurveyBtn: document.getElementById('newSurveyBtn')
        };

        // Initialize
        async function init() {
            await loadSurveys();
            setupEventListeners();
        }

        // Switch login tabs
        function switchLoginTab(tab) {
            const userTab = document.querySelector('.login-tab:first-child');
            const adminTab = document.querySelector('.login-tab:last-child');
            
            if (tab === 'user') {
                userTab.classList.add('active');
                adminTab.classList.remove('active');
                elements.userLoginTab.classList.add('active');
                elements.adminLoginTab.classList.remove('active');
            } else {
                adminTab.classList.add('active');
                userTab.classList.remove('active');
                elements.adminLoginTab.classList.add('active');
                elements.userLoginTab.classList.remove('active');
            }
        }

        // Handle user login
        async function handleUserLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            
            try {
                // Hash password (simple SHA-256)
                const passwordHash = await hashPassword(password);
                
                // Fetch user from Supabase
                const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/users?username=eq.${username}&password=eq.${passwordHash}`, {
                    headers: {
                        'apikey': CONFIG.SUPABASE_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                    }
                });
                
                const users = await response.json();
                
                if (users.length > 0) {
                    state.loggedInUser = users[0];
                    state.isAdmin = false;
                    state.userName = users[0].name;
                    state.language = users[0].language || 'en';
                    
                    // Show name field and hide dev mode for regular users
                    document.getElementById('userNameGroup').style.display = 'flex';
                    document.getElementById('devModeGroup').style.display = 'none';
                    
                    // Pre-fill setup form
                    elements.userName.value = users[0].name;
                    elements.language.value = users[0].language || 'en';
                    
                    switchPage('setup');
                } else {
                    alert('Invalid username or password');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        // Handle admin login
        async function handleAdminLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === 'admin' && password === '123') {
                state.loggedInUser = { name: 'Admin', username: 'admin', role: 'Admin' };
                state.isAdmin = true;
                
                // Hide name field and dev mode checkbox for admin
                document.getElementById('userNameGroup').style.display = 'none';
                document.getElementById('devModeGroup').style.display = 'none';
                
                // Auto-enable dev mode for admin
                elements.devMode.checked = true;
                elements.userName.value = 'Admin';
                
                switchPage('setup');
            } else {
                alert('Invalid admin credentials');
            }
        }

        // Hash password (SHA-256)
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return Array.from(new Uint8Array(hash))
                .map(b => b.toString(16).padStart(2, '0'))
                .join('');
        }

        // Load surveys from Supabase
        async function loadSurveys() {
            try {
                const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/surveys?status=eq.Deployed&order=created_at.desc`, {
                    headers: {
                        'apikey': CONFIG.SUPABASE_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                    }
                });
                
                const surveys = await response.json();
                
                elements.surveySelect.innerHTML = surveys.length > 0 
                    ? surveys.map(s => `<option value="${s.id}">${s.id}: ${s.title}</option>`).join('')
                    : '<option value="">No deployed surveys found</option>';
                    
            } catch (error) {
                console.error('Error loading surveys:', error);
                elements.surveySelect.innerHTML = '<option value="">Error loading surveys</option>';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login tab buttons
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabType = this.getAttribute('data-tab');
                    switchLoginTab(tabType);
                });
            });
            
            elements.userLoginForm.addEventListener('submit', handleUserLogin);
            elements.adminLoginForm.addEventListener('submit', handleAdminLogin);
            elements.setupForm.addEventListener('submit', handleSetupSubmit);
            elements.pauseBtn.addEventListener('click', handlePauseToggle);
            elements.explainBtn.addEventListener('click', handleExplain);
            elements.submitBtn.addEventListener('click', handleSubmit);
            elements.newSurveyBtn.addEventListener('click', handleNewSurvey);
            
            // Admin panel buttons
            document.getElementById('processAdminBtn').addEventListener('click', handleAdminProcess);
            document.getElementById('backToSetupBtn').addEventListener('click', () => switchPage('setup'));
        }

        // Handle setup form submission
        async function handleSetupSubmit(e) {
            e.preventDefault();
            
            state.userName = elements.userName.value;
            state.language = elements.language.value;
            state.selectedSurvey = elements.surveySelect.value;
            state.devMode = elements.devMode.checked;
            
            if (!state.userName || !state.selectedSurvey) {
                alert('Please fill in all fields');
                return;
            }

            if (state.devMode) {
                elements.devBadge.classList.remove('hidden');
            }

            try {
                // Load survey questions (not script yet)
                await loadSurveyScript();
                
                // Check if questions were loaded successfully
                if (!state.rawQuestions || state.rawQuestions.length === 0) {
                    return; // Error already handled in loadSurveyScript
                }
                
                // If admin, go to admin panel where script will be generated
                if (state.isAdmin) {
                    switchPage('adminPanel');
                    await generateConversationalScript();
                    renderAdminPanel();
                } else {
                    // For regular users, generate script and start survey
                    await generateConversationalScript();
                    switchPage('survey');
                    startSurveyFlow();
                }
            } catch (error) {
                console.error('Setup submission error:', error);
                // Error already handled, just return
            }
        }

        // Load survey script
        async function loadSurveyScript() {
            try {
                // Fetch survey details from Supabase
                const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/surveys?id=eq.${state.selectedSurvey}&select=*`, {
                    headers: {
                        'apikey': CONFIG.SUPABASE_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                    }
                });
                
                const surveys = await response.json();
                if (!surveys || surveys.length === 0) {
                    throw new Error('Survey not found in database');
                }
                
                const survey = surveys[0];
                console.log('Survey details:', survey);
                
                // Get json_path from survey (e.g., "survey_jsons\\design_1766478779.json")
                const jsonPath = survey.json_path;
                if (!jsonPath) {
                    throw new Error('Survey has no json_path specified');
                }
                
                console.log('Survey json_path:', jsonPath);

                // Build a list of candidate URLs to try in order
                const fileName = jsonPath.split(/[\\/]/).pop();
                const candidateUrls = [];

                if (jsonPath.startsWith('http://') || jsonPath.startsWith('https://')) {
                    candidateUrls.push(jsonPath);
                } else {
                    const normalizedPath = jsonPath.replace(/\\/g, '/');
                    candidateUrls.push(normalizedPath); // as-is path (relative to app root)
                    candidateUrls.push(`survey_jsons/${fileName}`); // local folder fallback
                    candidateUrls.push(`${CONFIG.SUPABASE_URL}/storage/v1/object/public/survey_jsons/${fileName}`); // Supabase Storage public bucket (jsons)
                    candidateUrls.push(`${CONFIG.SUPABASE_URL}/storage/v1/object/public/${CONFIG.SUPABASE_FORMS_BUCKET}/${fileName}`); // Supabase Storage public bucket (forms)
                }

                let jsonResponse = null;
                let resolvedPath = null;

                for (const url of candidateUrls) {
                    try {
                        const isStorage = url.includes('/storage/v1/object/');
                        const res = await fetch(url, {
                            headers: isStorage ? {
                                'apikey': CONFIG.SUPABASE_KEY,
                                'Authorization': `Bearer ${CONFIG.SUPABASE_KEY}`
                            } : undefined
                        });

                        if (res.ok) {
                            jsonResponse = res;
                            resolvedPath = url;
                            break;
                        }

                        console.warn(`File not found at ${url} (status ${res.status})`);
                    } catch (err) {
                        console.warn(`Fetch failed for ${url}:`, err);
                    }
                }

                if (!jsonResponse || !jsonResponse.ok) {
                    throw new Error(`Survey file not found. Tried: ${candidateUrls.join(', ')}.`);
                }

                const questions = await jsonResponse.json();
                console.log('Loaded questions from', resolvedPath, questions.length);
                
                if (!questions || questions.length === 0) {
                    throw new Error('No questions found in survey file');
                }
                
                // Limit questions in dev mode
                if (state.devMode && questions.length > 2) {
                    state.rawQuestions = questions.slice(0, 2);
                } else {
                    state.rawQuestions = questions;
                }
                
                console.log('Questions loaded successfully:', state.rawQuestions.length);
            } catch (error) {
                console.error('Error loading survey questions:', error);
                state.rawQuestions = []; // Initialize as empty array to prevent undefined errors
                alert('Failed to load survey questions: ' + error.message + '\n\nThe survey file does not exist in your survey_jsons folder. Please create or upload the survey file first.');
                switchPage('setup');
                throw error; // Re-throw to prevent further processing
            }
        }

        // Generate conversational script from raw questions
        async function generateConversationalScript() {
            // Safety check
            if (!state.rawQuestions || state.rawQuestions.length === 0) {
                console.error('No raw questions available to generate script');
                alert('No questions available to generate conversational script');
                return;
            }
            
            const questions = state.rawQuestions;
            
            // Show loading message on admin panel
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'scriptLoadingDiv';
            loadingDiv.className = 'alert alert-info';
            loadingDiv.innerHTML = '<div class="loading"></div> Generating conversational script with AI...';
            
            if (state.isAdmin) {
                document.getElementById('adminQuestions').appendChild(loadingDiv);
            }
            
            // Generate conversational script using Gemini API
            state.script = [];
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                
                // Update loading message
                loadingDiv.innerHTML = `<div class="loading"></div> Generating script for question ${i + 1}/${questions.length}...`;
                
                try {
                    // Call Gemini API to generate conversational script
                    const geminiResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GOOGLE_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: `Create a JSON object for a conversational survey with three keys: "say", "explain", "question_key".
"say": A friendly way to ask the question in simple language.
"explain": A more detailed explanation if needed.
"question_key": Use this exact text: "${question.question}"
The output must be a single, valid JSON object.
Question: ${question.question}
Description: ${question.description || 'No additional description'}`
                                }]
                            }]
                        })
                    });
                    
                    const result = await geminiResponse.json();
                    let scriptText = result.candidates[0].content.parts[0].text;
                    
                    // Extract JSON from markdown code blocks if present
                    if (scriptText.includes('```')) {
                        const parts = scriptText.split('```');
                        scriptText = parts[1];
                        if (scriptText.startsWith('json')) {
                            scriptText = scriptText.substring(4);
                        }
                        scriptText = scriptText.trim();
                    }
                    
                    const scriptPart = JSON.parse(scriptText);
                    state.script.push(scriptPart);
                } catch (error) {
                    console.error('Error generating script for question:', error);
                    // Fallback to simple format
                    state.script.push({
                        say: question.question,
                        explain: question.description || 'Please answer this question.',
                        question_key: question.question
                    });
                }
            }
            
            loadingDiv.remove();
            console.log('Script generated successfully:', state.script.length, 'questions');
        }

        // Render admin panel with questions
        function renderAdminPanel() {
            const surveyName = document.querySelector(`#surveySelect option[value="${state.selectedSurvey}"]`).textContent;
            document.getElementById('surveyTitle').textContent = surveyName;
            
            const container = document.getElementById('adminQuestions');
            container.innerHTML = '';
            
            state.recordedAnswers = new Array(state.script.length).fill(null);
            
            state.script.forEach((question, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                card.innerHTML = `
                    <div class="question-header">Question ${index + 1}</div>
                    
                    <div class="script-row">
                        <div class="script-label">Original:</div>
                        <div class="script-text">${question.question_key}</div>
                        <button class="btn-play" onclick="playQuestionAudio('${question.question_key.replace(/'/g, "\\'")}', ${index}, 'original')">
                            ‚ñ∂Ô∏è Play
                        </button>
                    </div>
                    
                    <div class="script-row">
                        <div class="script-label">Conversational:</div>
                        <div class="script-text">${question.say}</div>
                        <button class="btn-play" onclick="playQuestionAudio('${question.say.replace(/'/g, "\\'")}', ${index}, 'conversational')">
                            ‚ñ∂Ô∏è Play
                        </button>
                    </div>
                    
                    <button class="btn-record" id="recordBtn${index}" onclick="recordQuestionAnswer(${index})">
                        üéôÔ∏è Record Answer
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // Play question audio (global function)
        window.playQuestionAudio = async function(text, index, type) {
            await playTextToSpeech(text, state.language);
        };

        // Record answer for specific question (global function)
        window.recordQuestionAnswer = async function(index) {
            const btn = document.getElementById(`recordBtn${index}`);
            btn.textContent = 'üéôÔ∏è Recording (5 seconds)...';
            btn.disabled = true;
            
            try {
                const audioBlob = await recordAudio(CONFIG.RECORDING_DURATION);
                state.recordedAnswers[index] = {
                    audio: audioBlob,
                    transcription: null
                };
                
                btn.textContent = '‚úÖ Recorded';
                btn.classList.add('recorded');
            } catch (error) {
                console.error('Recording error:', error);
                alert('Failed to record. Please allow microphone access.');
                btn.textContent = 'üéôÔ∏è Record Answer';
            }
            
            btn.disabled = false;
        };

        // Handle admin process all answers
        async function handleAdminProcess() {
            // Fill missing answers with "No audio detected"
            state.recordedAnswers = state.recordedAnswers.map(answer => {
                if (answer === null) {
                    return {
                        audio: null,
                        transcription: 'No audio detected'
                    };
                }
                return answer;
            });
            
            switchPage('processing');
            processAnswers();
        }

        // Switch pages
        function switchPage(page) {
            elements.loginPage.classList.add('hidden');
            elements.setupPage.classList.add('hidden');
            elements.adminPanel.classList.add('hidden');
            elements.surveyPage.classList.add('hidden');
            elements.processingPage.classList.add('hidden');
            
            if (page === 'login') {
                elements.loginPage.classList.remove('hidden');
            } else if (page === 'setup') {
                elements.setupPage.classList.remove('hidden');
            } else if (page === 'adminPanel') {
                elements.adminPanel.classList.remove('hidden');
            } else if (page === 'survey') {
                elements.surveyPage.classList.remove('hidden');
            } else if (page === 'processing') {
                elements.processingPage.classList.remove('hidden');
            }
            
            state.currentPage = page;
        }

        // Start survey flow
        async function startSurveyFlow() {
            // Check if paused
            if (state.isPaused) {
                return;
            }

            if (state.currentStep >= state.script.length) {
                switchPage('processing');
                processAnswers();
                return;
            }

            updateProgress();
            
            const currentQuestion = state.script[state.currentStep];
            elements.questionNumber.textContent = `Question ${state.currentStep + 1}/${state.script.length}`;
            elements.questionText.textContent = currentQuestion.say;
            
            if (state.surveyFlowState === 'asking') {
                await askQuestion();
            } else if (state.surveyFlowState === 'countdown') {
                await showCountdown();
            } else if (state.surveyFlowState === 'recording') {
                await recordAnswer();
            }
        }

        // Ask question with TTS
        async function askQuestion() {
            elements.avatarImage.src = 'assets/avatar.gif';
            
            const currentQuestion = state.script[state.currentStep];
            await playTextToSpeech(currentQuestion.say, state.language);
            
            elements.avatarImage.src = 'assets/avatar_static.png';
            
            state.surveyFlowState = 'countdown';
            startSurveyFlow();
        }

        // Show countdown
        async function showCountdown() {
            elements.countdownDisplay.classList.remove('hidden');
            
            for (let i = CONFIG.COUNTDOWN_DURATION; i > 0; i--) {
                if (state.isPaused) {
                    elements.countdownDisplay.classList.add('hidden');
                    return;
                }
                elements.countdownDisplay.textContent = i;
                await sleep(1000);
            }
            
            elements.countdownDisplay.classList.add('hidden');
            
            if (!state.isPaused) {
                state.surveyFlowState = 'recording';
                startSurveyFlow();
            }
        }

        // Record answer
        async function recordAnswer() {
            elements.recordingIndicator.classList.remove('hidden');
            
            const audioBlob = await recordAudio(CONFIG.RECORDING_DURATION);
            state.recordedAnswers.push({
                audio: audioBlob,
                transcription: null // Will be filled during processing
            });
            
            elements.recordingIndicator.classList.add('hidden');
            
            state.currentStep++;
            state.surveyFlowState = 'asking';
            await sleep(1000);
            startSurveyFlow();
        }

        // Record audio from microphone
        function recordAudio(duration) {
            return new Promise((resolve, reject) => {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        const mediaRecorder = new MediaRecorder(stream);
                        const audioChunks = [];
                        
                        mediaRecorder.ondataavailable = event => {
                            audioChunks.push(event.data);
                        };
                        
                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                            stream.getTracks().forEach(track => track.stop());
                            resolve(audioBlob);
                        };
                        
                        mediaRecorder.start();
                        setTimeout(() => mediaRecorder.stop(), duration);
                    })
                    .catch(reject);
            });
        }

        // Play text to speech
        async function playTextToSpeech(text, lang) {
            try {
                const response = await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${CONFIG.GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: { text },
                        voice: {
                            languageCode: lang === 'hi' ? 'hi-IN' : 'en-US',
                            name: lang === 'hi' ? 'hi-IN-Wavenet-A' : 'en-US-Neural2-F'
                        },
                        audioConfig: {
                            audioEncoding: 'MP3',
                            speakingRate: 1.0
                        }
                    })
                });
                
                const result = await response.json();
                const audioData = `data:audio/mp3;base64,${result.audioContent}`;
                
                return new Promise((resolve) => {
                    elements.ttsAudio.src = audioData;
                    elements.ttsAudio.onended = resolve;
                    elements.ttsAudio.play();
                });
            } catch (error) {
                console.error('TTS error:', error);
                await sleep(2000); // Fallback delay
            }
        }

        // Transcribe audio using Google Speech-to-Text
        async function transcribeAudio(audioBlob) {
            try {
                const reader = new FileReader();
                const audioBase64 = await new Promise((resolve) => {
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.readAsDataURL(audioBlob);
                });
                
                const response = await fetch(`https://speech.googleapis.com/v1/speech:recognize?key=${CONFIG.GOOGLE_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config: {
                            encoding: 'WEBM_OPUS',
                            languageCode: 'en-US',
                            alternativeLanguageCodes: ['hi-IN'],
                            enableAutomaticPunctuation: true
                        },
                        audio: { content: audioBase64 }
                    })
                });
                
                const result = await response.json();
                
                if (result.results && result.results.length > 0) {
                    return result.results[0].alternatives[0].transcript;
                } else {
                    return 'No speech detected';
                }
            } catch (error) {
                console.error('Transcription error:', error);
                return 'ERROR - TRANSCRIPTION FAILED';
            }
        }

        // Process all answers
        async function processAnswers() {
            const results = {};
            
            for (let i = 0; i < state.recordedAnswers.length; i++) {
                const answer = state.recordedAnswers[i];
                const question = state.script[i];
                
                elements.processingProgress.innerHTML = `
                    <div class="alert alert-info">
                        <div class="loading"></div>
                        Processing answer ${i + 1}/${state.recordedAnswers.length}...
                    </div>
                `;
                
                let transcription;
                if (answer.transcription) {
                    transcription = answer.transcription;
                } else if (answer.audio) {
                    transcription = await transcribeAudio(answer.audio);
                } else {
                    transcription = 'No speech detected';
                }
                
                results[question.question_key] = transcription;
            }
            
            displayResults(results);
        }

        // Display results
        function displayResults(results) {
            elements.processingProgress.innerHTML = '<div class="alert alert-success">‚úÖ All answers processed!</div>';
            
            let html = '<h2>Final Results:</h2>';
            Object.entries(results).forEach(([question, answer]) => {
                html += `
                    <div class="result-item">
                        <div class="result-question">${question}</div>
                        <div class="result-answer">${answer}</div>
                    </div>
                `;
            });
            
            elements.resultsContainer.innerHTML = html;
            elements.resultsContainer.classList.remove('hidden');
            elements.processingControls.classList.remove('hidden');
            
            // Store results for submission
            state.finalResults = results;
        }

        // Handle pause/resume
        function handlePauseToggle() {
            state.isPaused = !state.isPaused;
            
            if (state.isPaused) {
                elements.pauseBtn.innerHTML = '‚ñ∂Ô∏è Resume Survey';
                elements.pausedWarning.classList.remove('hidden');
            } else {
                elements.pauseBtn.innerHTML = '‚è∏Ô∏è Pause Survey';
                elements.pausedWarning.classList.add('hidden');
                // Resume the survey flow
                startSurveyFlow();
            }
        }

        // Handle explain button
        async function handleExplain() {
            const currentQuestion = state.script[state.currentStep];
            elements.explanationBox.textContent = currentQuestion.explain;
            elements.explanationBox.classList.remove('hidden');
            
            elements.avatarImage.src = 'assets/avatar.gif';
            await playTextToSpeech(currentQuestion.explain, state.language);
            elements.avatarImage.src = 'assets/avatar_static.png';
            
            setTimeout(() => {
                elements.explanationBox.classList.add('hidden');
            }, 5000);
        }

        // Handle submit
        async function handleSubmit() {
            try {
                const response = await fetch(`${CONFIG.API_BASE_URL}/submit/${state.selectedSurvey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(state.finalResults)
                });
                
                if (response.ok) {
                    alert('Results submitted successfully!');
                } else {
                    alert('Failed to submit results');
                }
            } catch (error) {
                console.error('Submit error:', error);
                alert('Failed to submit results via API');
            }
        }

        // Handle new survey
        function handleNewSurvey() {
            location.reload();
        }

        // Update progress bar
        function updateProgress() {
            const progress = ((state.currentStep + 1) / state.script.length) * 100;
            elements.progressFill.style.width = `${progress}%`;
        }

        // Utility function: sleep
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Start the application
        init();
    </script>
</body>
</html>
